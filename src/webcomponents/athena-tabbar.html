<dom-module id="athena-tabbar">

<link rel="import" href="athena-tab.html">

<template>

    <style>
        .outer {
            cursor: default;
            font-family: "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;
            font-size: 11px;
            line-height: 13px;
            transition : background 200ms;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background : #cccccc;
        }
    </style>

    <div class="outer" on-mouseleave="_resizeTabs">
        <content id="tabs" select="athena-tab"></content>
    </div>

</template>

<script>
    Polymer({
        is: "athena-tabbar",

        properties: {
            selectedIndex: {
                type: Number,
                value: -1,
                notify: true,
                reflectToAttribute: true,
                observer: "_selectedIndexChanged"
            }
        },

        attached() {
            this._observer = Polymer.dom(this.$.tabs).observeNodes(info => {
                this._updateTabListeners(info.addedNodes, this.listen.bind(this));
                this._updateTabListeners(info.removedNodes, this.unlisten.bind(this));

                const tabs = this.getEffectiveChildren();
                const oldLastIndex = tabs.length - info.addedNodes.length + info.removedNodes.length - 1;
                const resizeImmediately = info.addedNodes.length > 0 ||
                    info.removedNodes.some(tab => tab.index === oldLastIndex);

                this._renumberTabs();
                if (resizeImmediately) {
                    this._resizeTabs();
                }

                if (info.addedNodes.length > 0) {
                    this._activateTab(info.addedNodes[info.addedNodes.length - 1]);
                } else if (this.selectedIndex >= tabs.length) {
                    this._activateTab(tabs[tabs.length - 1]);
                } else if (this.selectedIndex !== -1) {
                    this._activateTab(tabs[this.selectedIndex]);
                }
            });
        },

        detached() {
            this._updateTabListeners(this.getEffectiveChildren(), this.unlisten.bind(this));
            Polymer.dom(this.$.tabs).unobserveNodes(this._observer);
            this._observer = null;
        },

        _updateTabListeners(tabs, listenFn) {
            for (let tab of tabs) {
                listenFn(tab, "click-tab", "_clickTab");
                listenFn(tab, "close-tab", "_closeTab");
            }
        },

        _selectedIndexChanged(selectedIndex) {
            const index = Number(selectedIndex);
            const tabs = this.getEffectiveChildren();
            for (let i = 0; i < tabs.length; ++i) {
                tabs[i].active = (i === index);
            }
        },

        _activateTab(tab) {
            console.log(`activate-tab ${tab.id}`);
            if (this._fireTabEvent("activate-tab", tab)) {
                this.selectedIndex = tab.index;
            }
        },

        _clickTab(event) {
            event.stopPropagation();
            this._activateTab(event.currentTarget);
        },

        _closeTab(event) {
            event.stopPropagation();
            const tab = event.currentTarget;
            if (this._fireTabEvent("close-tab", tab)) {
                this.removeChild(tab);
            }
        },

        _fireTabEvent(eventName, tab) {
            let event = this.fire(eventName, {tab: tab}, {cancelable: true});
            return !event.defaultPrevented;
        },

        _renumberTabs() {
            const tabs = this.getEffectiveChildren();
            for (let i = 0; i < tabs.length; ++i) {
                tabs[i].index = i;
            }
        },

        _resizeTabs() {
            const tabs = this.getEffectiveChildren();
            const width = `${100/tabs.length}%`;
            for (let i = 0; i < tabs.length; ++i) {
                tabs[i].width = width;
            }
        }
    });
</script>

</dom-module>